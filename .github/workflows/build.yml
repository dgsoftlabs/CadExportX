name: CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Version bump type (only for main branch)'
        required: false
        type: choice
        options:
          - patch
          - minor
          - major
        default: 'patch'

jobs:
  build-and-test:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      
    - name: Add NuGet source
      run: nuget sources add -name nuget.org -source https://api.nuget.org/v3/index.json
      continue-on-error: true
        
    - name: Restore NuGet packages
      run: nuget restore
    
    - name: Build
      run: msbuild /p:Configuration=Release /p:Platform="Any CPU" /p:ResolveComReferenceSilent=true /p:EmbedInteropTypes=true
      
    - name: Run tests
      run: dotnet test CadExportX.Tests/CadExportX.Tests.csproj --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=test-results.trx"
      
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: '**/test-results.trx'
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      with:
        name: build-output
        path: CadExportX/bin/Release/net8.0-windows/

  create-release:
    needs: build-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: windows-latest
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-output
        path: CadExportX/bin/Release/net8.0-windows/
      
    - name: Get latest tag and bump version
      id: bump_version
      shell: pwsh
      run: |
        git fetch --tags
        $latestTag = git tag --sort=-v:refname | Select-Object -First 1
        
        if ([string]::IsNullOrEmpty($latestTag)) {
          $newVersion = "0.1.0"
        } else {
          $version = $latestTag -replace '^v', ''
          $versionParts = $version -split '\.'
          
          $major = [int]$versionParts[0]
          $minor = [int]$versionParts[1]
          $patch = [int]$versionParts[2]
          
          $bumpType = "${{ github.event.inputs.bump_type }}"
          if ([string]::IsNullOrEmpty($bumpType)) {
            $bumpType = "patch"
          }
          
          switch ($bumpType) {
            "major" {
              $major++
              $minor = 0
              $patch = 0
            }
            "minor" {
              $minor++
              $patch = 0
            }
            "patch" {
              $patch++
            }
          }
          
          $newVersion = "$major.$minor.$patch"
        }
        
        $newTag = "v$newVersion"
        echo "NEW_VERSION=$newVersion" >> $env:GITHUB_OUTPUT
        echo "NEW_TAG=$newTag" >> $env:GITHUB_OUTPUT
        echo "New version will be: $newTag"
      
    - name: Create Release Package
      shell: pwsh
      run: |
        $releaseDir = "release-package"
        New-Item -ItemType Directory -Force -Path $releaseDir
        
        $excludePatterns = @("^Ac", "^Ad")
        $binPath = "CadExportX/bin/Release/net8.0-windows"
        
        Copy-Item "$binPath/CadExportX.dll" -Destination $releaseDir
        
        Get-ChildItem "$binPath/*.dll" | Where-Object {
          $name = $_.Name
          $shouldExclude = $false
          foreach ($pattern in $excludePatterns) {
            if ($name -match $pattern) {
              $shouldExclude = $true
              break
            }
          }
          -not $shouldExclude -and $name -ne "CadExportX.dll"
        } | Copy-Item -Destination $releaseDir
        
        @"
CadExportX v${{ steps.bump_version.outputs.NEW_VERSION }}

This software is provided "as is", without warranty of any kind, express or implied.
In no event shall the authors or copyright holders be liable for any claim, damages or other liability.
"@ | Out-File -FilePath "$releaseDir/README.txt" -Encoding UTF8
    
    - name: Create ZIP archive
      shell: pwsh
      run: |
        Compress-Archive -Path "release-package/*" -DestinationPath "CadExportX-v${{ steps.bump_version.outputs.NEW_VERSION }}.zip"
    
    - name: Create and push new tag
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag ${{ steps.bump_version.outputs.NEW_TAG }}
        git push origin ${{ steps.bump_version.outputs.NEW_TAG }}
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.bump_version.outputs.NEW_TAG }}
        name: CadExportX ${{ steps.bump_version.outputs.NEW_VERSION }}
        draft: false
        prerelease: false
        generate_release_notes: true
        files: |
          CadExportX-v${{ steps.bump_version.outputs.NEW_VERSION }}.zip
          release-package/CadExportX.dll
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
